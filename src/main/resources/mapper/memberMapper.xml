<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.app.bookJeog.mapper.MemberMapper">
    <!-- 관리자 페이지 조회-->
    <select id="selectAllPersonal" resultType="personalMemberVO">
        select pm.id, member_email, member_name, member_phone, member_phone, member_mileage, member_status, createdDate, updatedDate
        from tbl_personal_member pm
        join tbl_member m
        on pm.id = m.id
    </select>

    <!--페이지네이션용 카운트-->
    <select id="countAllPersonal" resultType="_int">
        select count(*)
        from tbl_personal_member pm
                 join tbl_member m
                      on pm.id = m.id
    </select>


    <!--일반 회원가입-->
    <insert id="insertCommonMember" useGeneratedKeys="true" keyProperty="id">
        insert into tbl_member (member_type)
        values(#{memberType})
    </insert>


    <!--일반 회원가입-->
    <insert id="insertPersonalMember">
        insert into tbl_personal_member (id, member_email, member_password, member_name, member_birth, member_gender, member_phone, member_nickname)
        values (#{id}, #{memberEmail}, #{memberPassword}, #{memberName}, #{memberBirth}, #{memberGender}, #{memberPhone}, #{memberNickName})
    </insert>


    <!--이메일 중복검사-->
    <select id="selectByEmail" resultType="personalMemberVO">
        select *
        from tbl_personal_member
        where member_email = #{memberEmail}
    </select>


    <!--로그인-->
    <select id="loginPersonal" resultType="personalMemberVO">
        select *
        from tbl_personal_member
        where member_email = #{memberEmail} and member_password
    </select>

    <!--  기업회원 통합검색 조회  -->
    <select id="selectSponsorMembersWithProfile" resultType="sponsorMemberProfileDTO">
        select
            sm.id,
            sm.sponsor_name,
            f.file_name,
            f.file_path,
            m.createdDate as created_date,
            sm.sponsor_main_address,
            sm.sponsor_sub_address,
            sm.sponsor_phone_number
        from tbl_sponsor_member sm
                 join tbl_member m on sm.id = m.id
                 join tbl_member_profile mp on mp.member_id = m.id
                 join tbl_file f on f.id = mp.id
        where sm.sponsor_name like concat('%', #{keyword}, '%')
          and m.member_type = 'SPONSOR'
        limit 3
    </select>

    <!--  기업회원 검색 결과 개수 조회  -->
    <select id="selectSponsorMembersTotal" resultType="_int">
        select
            count(*)
        from tbl_sponsor_member sm
                 join tbl_member m on sm.id = m.id
                 join tbl_member_profile mp on mp.member_id = m.id
                 join tbl_file f on f.id = mp.id
        where sm.sponsor_name like concat('%', #{keyword}, '%')
          and m.member_type = 'SPONSOR'
    </select>

    <!--  기업회원 전체페이지 조회(무한스크롤)  -->
    <select id="selectAllSponsorMembers" resultType="sponsorMemberProfileDTO">
        select
            sm.id,
            sm.sponsor_name,
            f.file_name,
            f.file_path,
            m.createdDate as created_date,
            sm.sponsor_main_address,
            sm.sponsor_sub_address,
            sm.sponsor_phone_number
        from tbl_sponsor_member sm
                 join tbl_member m on sm.id = m.id
                 join tbl_member_profile mp on mp.member_id = m.id
                 join tbl_file f on f.id = mp.id
        where sm.sponsor_name like concat('%', #{keyword}, '%')
        and m.member_type = 'SPONSOR'
        <choose>
            <when test="sortType == 'name'">
                order by sm.sponsor_name collate utf8mb4_unicode_ci asc
            </when>
            <otherwise>
                order by m.createdDate desc
            </otherwise>
        </choose>
        limit 8 offset #{offset}
    </select>
</mapper>



